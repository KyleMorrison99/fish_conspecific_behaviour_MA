---
title: "The impacts of pesticide exposure on fish conspecific behavioural interactions:
  a systematic review and meta-analysis"
author: Kyle Morrison, Aneesh Bose, Rhiannon Eastment, Jack Manera, Gabriel Melhado, Marcus
  Michelangeli, Shiho Ozeki, Bob Wong, Yefeng Yang, Malgorzata Lagisz, Shinichi Nakagawa
date: "latest update: `r format(Sys.time(), '%d %B %Y')`"
output: html_document
output: 
  rmdformats::readthedown:
    code_folding: show
    code_download: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

# **Knit Settings**

```{r setup, include = FALSE}
# knitr setting
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  tidy = TRUE,
  cache = TRUE,
  echo=TRUE
)
```

# **Load packages and data**

## Load packages

```{r}
# rm(list = ls())
pacman::p_load(tidyverse,
               here,
               kableExtra,
               magrittr, 
               patchwork)


knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

## Load Data

```{r}
data <- read_csv(here("data", "fish_conspecific_behaviour_ma_data.csv"), skip = 0)

# Format ID variables as characters
data <- mutate_at(data, 
                  vars(study_id, 
                       exp_id, 
                       exp2_id, 
                       assay_id, 
                       assay2_id), 
                       as.character)
# Table of the dataset
data_table <- kable(data, "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "100%", height = "800px")

# Summary of the data set
summary_data_table <- kable(summary(data), "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "100%", height = "800px")
```


Theme design for study figures 


# **Aim 0: Data exploration and reporting of methodological items**

## Figure 1
b) A bubble plot showing the number of effect sizes of each pesticide class per conspecific behaviour described
c) A bar chart showing the total number of effect sizes per species

```{r}
# Group by "pesticide class" and "conspecific behaviour measured" and summarize count
pc_cb_summary <- data %>% 
  group_by(pesticide_chemical_class,behaviour_measured_standardised) %>% 
  summarise(n = n(), .groups = "drop")

# Filter for top 8 pesticides 
top_pesticides <- pc_cb_summary %>%
  group_by(pesticide_chemical_class ) %>%
  summarise(total_count = sum(n)) %>%
  top_n(9, total_count) %>%
  pull(pesticide_chemical_class) 

# Filter and modify the pc_cb_summary data to keep only top classes or label as "Other"
pc_cb_summary_filtered <- pc_cb_summary %>%
  mutate(pesticide_chemical_class = ifelse(pesticide_chemical_class %in% top_pesticides,
                                           pesticide_chemical_class,
                                           "Other Pesticide Classes")) %>%
  group_by(pesticide_chemical_class, behaviour_measured_standardised) %>%
  summarise(n = sum(n), .groups = "drop")

# Create the bubble plot
fig1b <- pc_cb_summary_filtered %>%
   ggplot(aes(x = fct_rev(fct_reorder(behaviour_measured_standardised, n, .fun = 'sum')),
             y = fct_reorder(pesticide_chemical_class, n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[3]) +
  scale_size_continuous(range = c(2, 20)) +
  scale_x_discrete(labels = function(x) tools::toTitleCase(str_wrap(x, width = 10))) +
  scale_y_discrete(labels = function(x) tools::toTitleCase(str_wrap(x, width = 10))) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position="none",
        text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in each cell is the number of effect sizes",
       x = "Behaviour Measured",
       y = "Pesticide Chemical Class",
       tag = "B")


# Group by "species"
sp_summary <- data %>% 
  group_by(species_english) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each species
species_pct <- sp_summary %>% 
  mutate(proportion = n / sum(n), # number of effect sizes
         percentage = proportion * 100)


fig1c <- sp_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(species_english), n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = ifelse(n < 9, "", n), x = n / 2, y = reorder(str_to_title(species_english), n)), hjust = 0.5, size = 4, color = "black") +
  geom_text(data = species_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n), 
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sp_summary$n)*1.2)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total number of effect size estimates",
       y = "Species",
       tag = "C")


fig1bc <- fig1b / fig1c


ggsave(here("figures", "fig1bc.pdf"), width = 8, height = 12, units = "cm", scale = 2, dpi = 800)
ggsave(here("figures", "fig1bc.jpg"), width = 8, height = 12, units = "cm", scale = 2, dpi = 800)

```


## Figure x
A bubble plot showing the number of effect sizes of each pesticide class per species described
```{r}
# Group by "pesticide class" and "species" and summarize count
pc_sp_summary <- data %>% 
  group_by(pesticide_chemical_class,species_english) %>% 
  summarise(n = n(), .groups = "drop")

# Create the bubble plot
figx <- pc_sp_summary %>% 
   ggplot(aes(x = fct_rev(fct_reorder(species_english, n, .fun = 'sum')),
             y = fct_reorder(pesticide_chemical_class, n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[3]) + 
  scale_size(range=c(5,15)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 10)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position="none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in the cell is the number of effect sizes",
       x = "Species",
       y = "Pesticide Chemical Class") +
   theme(plot.caption = element_text(size = 10, color = "gray10", face = "italic"))

figx
```

## Figure x
A bar chart showing the reporting of the source of fish used in the literature
```{r}
# Extract unique entries based on 'study_id' 
data_study <- data %>%
  distinct(study_id, .keep_all = TRUE) 

# Group by "source of fish"
source_summary <- data_study %>% 
  group_by(source) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each source
source_pct <- source_summary %>% 
  mutate(proportion = n / sum(n), # number of studies
         percentage = proportion * 100)


fig <- source_summary %>% 
  ggplot(aes(x = n, y = reorder(source, n))) + 
  geom_bar(stat = "identity", width = 0.8 , alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(source, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = source_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n), 
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(source_summary$n)*1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of studies",
       y = "Source of fish")

fig

```




```{r}
# Group by "sex of fish"
sex_summary <- data_study %>% 
  group_by(sex) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each sex
sex_pct <- sex_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Plot the data
fig <- sex_summary %>% 
  ggplot(aes(x = n, y = reorder(sex, n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(sex, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = sex_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sex_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of studies",
       y = "Sex of fish")

fig
```

```{r}
# Group by "control_solvent"
solvent_summary <- data_study %>% 
  group_by(control_solvent) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each control solvent
solvent_pct <- solvent_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Plot the data
fig <- solvent_summary %>% 
  ggplot(aes(x = n, y = reorder(control_solvent, n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(control_solvent, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = solvent_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(solvent_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of studies",
       y = "Control Solvent")

fig

```


```{r}
# Filter data for entries containing "sociality" in behaviour_measure_standardised
sociality_data <- data %>% 
  filter(grepl("sociality", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardized and count occurrences
sociality_assay_summary <- sociality_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each control solvent
sociality_assay_pct <- sociality_assay_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Plot the data
fig <- sociality_assay_summary %>%
  ggplot(aes(x = n, y = reorder(behavioural_assay_standardised, n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(behavioural_assay_standardised, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = sociality_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sociality_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of observations",
       y = "Sociality Assay")

fig
```

```{r}
# Filter data for entries containing "aggression" in behaviour_measure_standardised
aggression_data <- data %>% 
  filter(grepl("aggression", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardised and count occurrences
aggression_assay_summary <- aggression_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each behavioural assay
aggression_assay_pct <- aggression_assay_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of effect sizes
         percentage = proportion * 100)

# Plot the data
fig <- aggression_assay_summary %>%
  ggplot(aes(x = n, y = reorder(behavioural_assay_standardised, n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(behavioural_assay_standardised, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = aggression_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(aggression_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of observations",
       y = "Aggression Assay")

fig
```

```{r}
# Filter data for entries containing "courtship" in behaviour_measure_standardised
courtship_data <- data %>% 
  filter(grepl("courtship", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardised and count occurrences
courtship_assay_summary <- courtship_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each behavioural assay
courtship_assay_pct <- courtship_assay_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Plot the data
fig <- courtship_assay_summary %>%
  ggplot(aes(x = n, y = reorder(behavioural_assay_standardised, n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(behavioural_assay_standardised, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = courtship_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(courtship_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of observations",
       y = "Courtship Assay")

fig
```


```{r}

# Filter data for entries containing "collective behaviour" in behaviour_measure_standardised
collective_behaviour_data <- data %>% 
  filter(grepl("collective behaviour", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardised and count occurrences
collective_behaviour_assay_summary <- collective_behaviour_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each behavioural assay
collective_behaviour_assay_pct <- collective_behaviour_assay_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Plot the data
fig <- collective_behaviour_assay_summary %>%
  ggplot(aes(x = n, y = reorder(behavioural_assay_standardised, n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[4]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(behavioural_assay_standardised, n)), hjust = 0.5, size = 12, color = "black") +
  geom_text(data = collective_behaviour_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 12, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(collective_behaviour_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(color = "black")) +
  labs(x = "Total number of observations",
       y = "Collective Behaviour Assay")

fig
```

