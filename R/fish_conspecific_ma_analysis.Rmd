---
title: "The impacts of pesticide exposure on fish conspecific behavioural interactions: a systematic review and meta-analysis"
author: Kyle Morrison, Aneesh Bose, Rhiannon Eastment, Jack Manera, Gabriel Melhado, Marcus
  Michelangeli, Shiho Ozeki, Bob Wong, Yefeng Yang, Malgorzata Lagisz, Shinichi Nakagawa
date: "latest update: `r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    code_download: true
    theme: flatly   # Options: cerulean, journal, flatly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, yeti
    highlight: monochrome  # Options: default, tango, pygments, kate, monochrome, espresso, zenburn, haddock, textmate
editor_options: 
  chunk_output_type: console

---
```{r setup, include = FALSE}
# knitr setting
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  tidy = TRUE,
  cache = TRUE,
  echo=TRUE
)
```

# **Load packages and data**

## Load packages

```{r}
rm(list = ls())
pacman::p_load(tidyverse,
               here,
               kableExtra,
               magrittr, 
               patchwork,
               metafor,
               metagear)

```

## Load Data
```{r}
data <- read_csv(here("data", "fish_conspecific_behaviour_ma_data_pre_check.csv"), skip = 0)

# Format ID variables as characters
data <- mutate_at(data, 
                  vars(study_id, 
                       exp_id, 
                       exp2_id, 
                       assay_id, 
                       assay2_id), 
                       as.character)
# Table of the dataset
 kable(data, "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "250%", height = "800px")


# Summary of the data set
kable(summary(data), "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "250%", height = "500px")
```


# **Data exploration and reporting of methodological items**
## Main text Figure 1
b) A bubble plot showing the number of effect sizes of each pesticide class per conspecific interaction behaviour described
c) A bar chart showing the total number of effect sizes per species
```{r,fig.width=8, fig.height=13}
# Summarize data by grouping on pesticide chemical class and behavior measured, then count entries.
pc_cb_summary <- data %>% 
  group_by(pesticide_chemical_class, behaviour_measured_standardised) %>% 
  summarise(n = n(), .groups = "drop")

# Determine the top 9 pesticide classes based on the number of records.
top_pesticide_class <- pc_cb_summary %>%
  group_by(pesticide_chemical_class) %>%
  summarise(total_count = sum(n)) %>%
  top_n(9, total_count) %>%
  pull(pesticide_chemical_class)

# Adjust category names to 'Other pesticide classes' for those pesticide classes not in the top 9
pc_cb_summary_filtered <- pc_cb_summary %>%
  mutate(pesticide_chemical_class = ifelse(pesticide_chemical_class %in% top_pesticide_class,
                                           pesticide_chemical_class,
                                           "Other Pesticide Classes")) %>%
  group_by(pesticide_chemical_class, behaviour_measured_standardised) %>%
  summarise(n = sum(n), .groups = "drop")

# Create the bubble plot
behaviour_pesticide_class_bubble_plot <- pc_cb_summary_filtered %>%
   ggplot(aes(x = fct_rev(fct_reorder(str_to_title(behaviour_measured_standardised), n, .fun = 'sum')),
             y = fct_reorder(str_to_title(pesticide_chemical_class), n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[3]) +
  scale_size_continuous(range = c(5, 20)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic"))  +
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in each cell is the number of effect sizes",
       x = "Behaviour Measured",
       y = "Pesticide Chemical Class",
       tag = "B")

# Group data by species, count entries, and drop groups post-summary.
sp_summary <- data %>% 
  group_by(species_english) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportion and percentage of total counts for each species.
species_pct <- sp_summary %>% 
  mutate(proportion = n / sum(n), 
         percentage = proportion * 100)

# Create the bar plot
species_effect_size_count_bar_plot <- sp_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(species_english), n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = ifelse(n < 9, "", n), x = n / 2, y = reorder(str_to_title(species_english), n)), hjust = 0.5, size = 4, color = "black") +
  geom_text(data = species_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n), 
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sp_summary$n) * 1.2)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total number of effect size estimates",
       y = "Species",
       tag = "C")

# Combine both plots into a single figure.
main_text_figure_1 <- behaviour_pesticide_class_bubble_plot / species_effect_size_count_bar_plot

print(main_text_figure_1)
# ggsave(here("figures", "main_text_figure_1.pdf"), width = 8, height = 13, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "main_text_figure_1.jpg"), width = 8, height = 13, units = "cm", scale = 2, dpi = 800)
```

# Supplementary figure xx
A bubble plot showing the number of effect sizes of each pesticide per conspecific interaction behaviour described
```{r,fig.width=8, fig.height=8}
# Group data by species, count entries, and drop groups post-summary.
p_cb_summary <- data %>%
  group_by(pesticide, behaviour_measured_standardised) %>%
  summarise(
    n = n(),
    pesticide_chemical_class = first(pesticide_chemical_class),
    .groups = "drop"
  )
# Determine the top 8 pesticide classes based on the number of records.
top_pesticides <- p_cb_summary %>%
  group_by(pesticide, behaviour_measured_standardised) %>%
  summarise(total_count = sum(n), .groups = "drop") %>%
  top_n(20, total_count) %>%
  pull(pesticide)

# Adjust category names to 'Other Pesticides' for all but the top pesticide, then re-summarize.
# p_cb_summary_filtered <- p_cb_summary %>%
# mutate(pesticide = ifelse(pesticide %in% top_pesticides,
#                                          pesticide,
#                                          "Other Pesticides")) %>%
#  group_by(pesticide, behaviour_measured_standardised) %>%
#  summarise(n = sum(n), .groups = "drop")


# Create the bubble plot for the behaviours assessed per pesticide (effect size as count)
behaviour_pesticide_bubble_plot <- p_cb_summary %>% # can add _filtered if needed
   ggplot(aes(x = fct_rev(fct_reorder(str_to_title(behaviour_measured_standardised), n, .fun = 'sum')),
             y = fct_reorder(str_to_title(pesticide), n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[5]) +
  scale_size_continuous(range = c(4, 20)) +
  theme_bw() +
  guides(size = "none") +
theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in each cell is the number of effect sizes",
       x = "Behaviour Measured",
       y = "Pesticide Chemical Class") +
      scale_y_discrete(labels = function(x) ifelse(x %in% c("Ddt", "Dca", "Dcpmu"), toupper(x), x))

print(behaviour_pesticide_bubble_plot)

# ggsave(here("figures", "behaviour_pesticide_bubble_plot.pdf"), width = 8, height = 12, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "behaviour_pesticide_bubble_plot.jpg"), width = 8, height = 12, units = "cm", scale = 2, dpi = 800)
```

```{r,fig.width=8, fig.height=6}
# Group data by species, count entries, and drop groups post-summary.
species_summary <- data %>%
  group_by(species_english, behaviour_measured_standardised) %>%
  summarise(
    n = n(),
    pesticide_chemical_class = first(pesticide_chemical_class),
    .groups = "drop"
  )

# Determine the top 20 species based on the number of records.
top_species <- species_summary %>%
  group_by(species_english, behaviour_measured_standardised) %>%
  summarise(total_count = sum(n), .groups = "drop") %>%
  top_n(20, total_count) %>%
  pull(species_english)

# Adjust category names to 'Other' for all but the top species, then re-summarize.
# species_summary_filtered <- species_summary %>%
#   mutate(species_english = ifelse(species_english %in% top_species,
#                                   species_english,
#                                   "Other Species")) %>%
#   group_by(species_english, behaviour_measured_standardised) %>%
#   summarise(n = sum(n), .groups = "drop")

# Create the bubble plot the behaviours assessed per species (number of effect size as count)
behaviour_species_bubble_plot <- species_summary %>% # can add _filtered if needed
  ggplot(aes(x = fct_rev(fct_reorder(str_to_title(behaviour_measured_standardised), n, .fun = 'sum')),
             y = fct_reorder(str_to_title(species_english), n, .fun = 'sum'),
             size = n)) +
  geom_point(alpha = 0.5, color = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  scale_size_continuous(range = c(8, 25)) +
  theme_bw() +
  guides(size = "none") +
theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) + 
  geom_text(aes(label = as.character(n)), size = 4, color = "gray10") +
  labs(caption = "The value in each cell is the number of effect sizes",
       x = "Behaviour Measured",
       y = "Species") +
  scale_color_brewer(palette = "Dark2", name = "Chemical Class")

print(behaviour_species_bubble_plot)

# ggsave(here("figures", "behaviour_species_bubble_plot.pdf"), width = 8, height = 6, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "behaviour_species_bubble_plot.jpg"), width = 8, height = 6, units = "cm", scale = 2, dpi = 800)
```

## Supplementary figure x
A bar chart showing the reporting of the source of fish used in the literature
```{r,fig.width=10, fig.height=5}
# Extracts unique records from the dataset based on 'study_id', retaining all other associated data.
data_study <- data %>%
  distinct(study_id, .keep_all = TRUE) 

# Groups the filtered data by 'source of fish' and counts the number of studies per source, removing grouping afterwards.
source_summary <- data_study %>% 
  group_by(source) %>% 
  summarise(n = n(), .groups = "drop")

# Calculates the proportion and percentage of total studies for each source of fish.
source_pct <- source_summary %>% 
  mutate(proportion = n / sum(n),  # number of studies
         percentage = proportion * 100)

# Create the bar plot for the source of fish study count
fish_source_study_count_bar_plot <- source_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(source), n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[1]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(str_to_title(source), n)), hjust = 0.5, size = 4, color = "black") +
  geom_text(data = source_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n), 
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(source_summary$n) * 1.2)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of studies",
       x = "Total number of studies",
       y = "Source of fish") 

print(fish_source_study_count_bar_plot)

# ggsave(here("figures", "fish_source_study_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "fish_source_study_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

## Figure x
A bar chart showing the sex of fish used in the literature
```{r,fig.width=10, fig.height=5}
# Group data by 'sex of fish' and count entries, then drop grouping for further analysis.
sex_summary <- data_study %>% 
  group_by(sex) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate proportions and percentages of total studies for each sex.
sex_pct <- sex_summary %>% 
  mutate(proportion = n / sum(n),  
         percentage = proportion * 100)

# Create a bar plot visualizing the number of studies per sex, with annotations for counts and percentages.
fish_sex_study_count_bar_plot <- sex_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(sex), n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[2]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(str_to_title(sex), n)), hjust = 0.5, size = 4, color = "black") +
  geom_text(data = sex_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n), 
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sex_summary$n) * 1.2)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of studies",
       x = "Total number of studies",
       y = "Sex of fish")

print(fish_sex_study_count_bar_plot)

# ggsave(here("figures", "fish_sex_study_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "fish_sex_study_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

## Supplementary Figure x 
A bar plot showing the control solvents used in the literature
```{r,fig.width=10, fig.height=5}
# Group data by 'control solvent' and count entries, then drop the group structure for further analysis.
solvent_summary <- data_study %>% 
  group_by(control_solvent) %>% 
  summarise(n = n(), .groups = "drop")

# Calculate the proportion and percentage of total studies for each control solvent.
solvent_pct <- solvent_summary %>% 
  mutate(proportion = n / sum(n), 
         percentage = proportion * 100)

# Create a bar plot visualizing the number of studies per control solvent, annotated with counts and percentages.
control_solvent_study_count_bar_plot <- solvent_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(control_solvent), n))) + 
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[3]) +
  geom_text(aes(label = n, x = n / 2, y = reorder(str_to_title(control_solvent), n)), hjust = 0.5, size = 4, color = "black") +
  geom_text(data = solvent_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(solvent_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of studies",
       x = "Total number of studies",
       y = "Control Solvent") +
  scale_y_discrete(labels = function(x) ifelse(x == "Dmso", toupper(x), ifelse(x == "Dtnb", toupper(x), x)))

print(control_solvent_study_count_bar_plot)

# ggsave(here("figures", "control_solvent_study_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "control_solvent_study_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

## Supplementary Figure x
A bar plot showing the behavioural assays used to quantify soliality in the literature
```{r,fig.width=10, fig.height=5}
# Filter data for entries containing "sociality" in behaviour_measure_standardised
sociality_data <- data %>% 
  filter(grepl("sociality", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardized and count occurrences
sociality_assay_summary <- sociality_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each control solvent
sociality_assay_pct <- sociality_assay_summary %>% 
  mutate(proportion = n / sum(n), 
         percentage = proportion * 100)

# Create a bar plot visualizing the number of studies quantifying pesticide impacts on aggression, annotated with counts and percentages.
sociality_assay_effect_size_count_bar_plot <- sociality_assay_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(behavioural_assay_standardised), n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[5]) +
  geom_text(aes(label = ifelse(n < 0, "", n), x = n / 2, y = reorder(str_to_title(behavioural_assay_standardised), n)), 
            hjust = 0.5, size = 4, color = "black") +
  geom_text(data = sociality_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(sociality_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total Number of Effect Sizes",
       y = "Sociality Assay")

print(sociality_assay_effect_size_count_bar_plot)

# ggsave(here("figures", "sociality_assay_effect_size_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "sociality_assay_effect_size_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

## Supplementary Figure x
A bar plot showing the behavioural assays used to quantify aggression in the literature
```{r,fig.width=10, fig.height=5}
# Filter data for entries containing "aggression" in behaviour_measure_standardised
aggression_data <- data %>% 
  filter(grepl("aggression", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardised and count occurrences
aggression_assay_summary <- aggression_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each behavioural assay
aggression_assay_pct <- aggression_assay_summary %>% 
  mutate(proportion = n / sum(n), 
         percentage = proportion * 100)

# Create a bar plot visualizing the number of studies quantifying pesticide impacts on aggression, annotated with counts and percentages.
aggression_assay_effect_size_count_bar_plot <- aggression_assay_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(behavioural_assay_standardised), n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[6]) +
  geom_text(aes(label = ifelse(n < 0, "", n), x = n / 2, y = reorder(str_to_title(behavioural_assay_standardised), n)), 
            hjust = 0.5, size = 4, color = "black") +
  geom_text(data = aggression_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(aggression_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total Number of Effect Sizes",
       y = "Aggression Assay")

print(aggression_assay_effect_size_count_bar_plot)

# ggsave(here("figures", "aggression_assay_effect_size_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "aggression_assay_effect_size_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

## Supplementary Figure x
A bar plot showing the behavioural assays used to quantify courtship in the literature
```{r,fig.width=10, fig.height=5}
# Filter data for entries containing "courtship" in behaviour_measure_standardised
courtship_data <- data %>% 
  filter(grepl("courtship", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardised and count occurrences
courtship_assay_summary <- courtship_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each behavioural assay
courtship_assay_pct <- courtship_assay_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Create a bar plot visualizing the number of studies quantifying pesticide impacts on courtship, annotated with counts and percentages.
courtship_assay_effect_size_count_bar_plot <- courtship_assay_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_title(behavioural_assay_standardised), n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[6]) +
  geom_text(aes(label = ifelse(n < 0, "", n), x = n / 2, y = reorder(str_to_title(behavioural_assay_standardised), n)), 
            hjust = 0.5, size = 4, color = "black") +
  geom_text(data = courtship_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(courtship_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total Number of Effect Sizes",
       y = "Courtship Assay")

print(courtship_assay_effect_size_count_bar_plot)

# ggsave(here("figures", "courtship_assay_effect_size_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "courtship_assay_effect_size_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

## Supplementary Figure x
A bar plot showing the behavioural assays used to quantify collective behaviour (i.e., behaviours measure at collective level) in the literature
```{r,fig.width=10, fig.height=5}
# Filter data for entries containing "collective behaviour" in behaviour_measure_standardised
collective_behaviour_data <- data %>% 
  filter(grepl("collective behaviour", behaviour_measured_standardised, ignore.case = TRUE))

# Group data by behavioural_assay_standardised and count occurrences
collective_behaviour_assay_summary <- collective_behaviour_data %>% 
  group_by(behavioural_assay_standardised) %>%
  summarise(n = n(), .groups = "drop")

# Calculate proportion of effect sizes for each behavioural assay
collective_behaviour_assay_pct <- collective_behaviour_assay_summary %>% 
  mutate(proportion = n / sum(n), # Adjust total number of observations
         percentage = proportion * 100)

# Create a bar plot visualizing the number of studies quantifying pesticide impacts on collective behaviour, annotated with counts and percentages.
collective_behaviour_assay_effect_size_count_bar_plot <- collective_behaviour_assay_summary %>%
  ggplot(aes(x = n, y = reorder(str_to_sentence(behavioural_assay_standardised), n))) +
  geom_bar(stat = "identity", width = 0.8, alpha = 0.5, fill = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[7]) +
  geom_text(aes(label = ifelse(n < 9, "", n), x = n / 2, y = reorder(str_to_sentence(behavioural_assay_standardised), n)), 
            hjust = 0.5, size = 4, color = "black") +
  geom_text(data = collective_behaviour_assay_pct, aes(label = paste0("(", round(percentage, 1), "%)"), x = n),
            hjust = -0.1, size = 4, color = "black", fontface = "bold") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(collective_behaviour_assay_summary$n) * 1.3)) +
  theme_bw() +
  guides(size = "none") +
  theme(legend.position = "none",
        axis.text = element_text(color = "black"),
        axis.title = element_text(face = "bold", color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "The value in each bar is the total number of effect sizes",
       x = "Total Number of Effect Sizes",
       y = "Collective Behaviour Assay")

print(collective_behaviour_assay_effect_size_count_bar_plot)

# ggsave(here("figures", "collective_behaviour_assay_effect_size_count_bar_plot.pdf"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "collective_behaviour_assay_effect_size_count_bar_plot.jpg"), width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```

# Supplentmentary Figure x
A box and violin plot showing the distribution of pesticide dosages used in the literature
```{r}
# making dosages consistent for dosage comparisons
data_dosage <- data %>%
  select(c(pesticide, pesticide_chemical_class,dosage, dosage_unit)) %>% 
  filter(dosage != "not reported") %>% 
filter(dosage_unit != "not reported") %>% 
filter(!dosage_unit %in% c("nm", "um", "nM")) %>%
  mutate(dosage = as.numeric(dosage),
         dosage_unit = as.character(dosage_unit),
         dosage_unit_consistent = case_when(
           dosage_unit == "mg/L" ~ "ug/L", 
           dosage_unit == "ng/L" ~ "ug/L",
           dosage_unit == "g/L" ~ "ug/L",
           dosage_unit == "ppb" ~ "ug/L", 
           dosage_unit == "ppm" ~ "ug/L", 
           TRUE ~ dosage_unit),
         dosage_convert_ugL = case_when(
           dosage_unit == "mg/L" ~ dosage * 1000,
           dosage_unit == "ng/L" ~ dosage / 1000,
           dosage_unit == "g/L" ~ dosage/1000000,
           dosage_unit == "ppm" ~ dosage*1000, 
           TRUE ~ dosage))

# Summary table for the dosage converted
summary_data_dosage <- summary(data_dosage$dosage_convert_ugL)

# Filter the data for dosage_convert_ugL less than 5000
filtered_data_dosage <- data_dosage %>%
  filter(dosage_convert_ugL < 3000)

# Create the violin plot
pesticide_dosage_violin_plot <- ggplot(filtered_data_dosage, aes(y = dosage_unit_consistent, x = dosage_convert_ugL)) +
    geom_violin(fill = RColorBrewer::brewer.pal(n = 8, name = "Set2")[1], alpha = 0.4, color = NA, trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white", color = RColorBrewer::brewer.pal(n = 8, name = "Set2")[2], outlier.shape = NA) +
  geom_jitter(width = 0.3, height = 0.09, color = RColorBrewer::brewer.pal(n = 8, name = "Set2")[1], alpha = 0.8) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face = "bold"),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "Plot filtered for less than 3000 ug/L\nMedian = 12, 1st Quartile = 1, 3rd Quartile = 500",
       y = "Dosage Unit [ug/L]")

print(pesticide_dosage_violin_plot)

# ggsave(here("figures", "pesticide_dosage_violin_plot.pdf"), plot = dosage_violin_plot, width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "pesticide_dosage_violin_plot.jpg"), plot = dosage_violin_plot, width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```


# Supplementary Figure x
A box and violin plot the distribution of durations of pesticide exposure 
```{r}
data_duration <- data %>% 
    select(c(pesticide, pesticide_chemical_class, duration, duration_unit)) %>%
  filter(!is.na(duration), duration != "not reported") %>%
  mutate(duration = as.numeric(duration),
         duration_unit = as.character(duration_unit),
           duration_unit_consistent = case_when(
          duration_unit == "minutes" ~ "hours",
          duration_unit == "days" ~ "hours",
          duration_unit == "weeks" ~ "hours",
           TRUE ~ duration_unit),
 duration_convert = case_when(
    duration_unit == "minutes" ~ duration/ 60, 
    duration_unit == "days" ~ duration*24, 
    duration_unit == "weeks" ~ duration*168,
    TRUE ~ duration))

summary(data_duration$duration_convert)

# Create the violin plot for duration
pesticide_duration_violin_plot <- ggplot(data_duration, aes(y = duration_unit_consistent, x = duration_convert)) +
  geom_violin(fill = RColorBrewer::brewer.pal(n = 8, name = "Set2")[1], alpha = 0.4, color = NA, trim = FALSE) +
  geom_boxplot(width = 0.1, fill = "white", color = RColorBrewer::brewer.pal(n = 8, name = "Set2")[2], outlier.shape = NA) +
  geom_jitter(width = 0.3, height = 0.09, color = RColorBrewer::brewer.pal(n = 8, name = "Set2")[1], alpha = 0.8) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face = "bold"),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_blank(),
        axis.ticks = element_line(color = "black"),
        plot.caption = element_text(size = 10, color = "gray10", face = "italic")) +
  labs(caption = "Median = 336, 1st Quartile = 96, 3rd Quartile = 960",
       y = "Duration [hours]")

print(pesticide_duration_violin_plot)

# ggsave(here("figures", "pesticide_duration_violin_plot.pdf"), plot = dosage_violin_plot, width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
# ggsave(here("figures", "pesticide_duration_violin_plot.jpg"), plot = dosage_violin_plot, width = 10, height = 5, units = "cm", scale = 2, dpi = 800)
```


# **Impute missing standard deviations and calculate effect size estimates**
We imputed the missing standard deviations using the formula provided in section 13.1 (p. 199) of the Handbook of Meta-analysis in Ecology and Evolution (Koricheva, Gurevitch, and Mengersen, 2013).

To ensure consistency in treatments subjected to repeated stepwise multiple comparisons (i.e., the same data used multiple times to calculate different effect sizes), we maintained the same imputed standard deviations (or standard errors) for the repeated data.

### Find SD/Mean ratio
A bar plot showing the SD/Mean ratio of the control and treatment groups in each primary study
```{r}
sd_mean_ratio_bar_plot <- data %>%
  mutate(
    control_sd = as.numeric(control_sd),
    treatment_sd = as.numeric(treatment_sd)
  ) %>%
  group_by(study_id) %>%
  mutate(
    within_study_control_mean = mean(control_mean, na.rm = TRUE),
    within_study_treatment_mean = mean(treatment_mean, na.rm = TRUE),
    within_study_control_sd = mean(control_sd, na.rm = TRUE),
    within_study_treatment_sd = mean(treatment_sd, na.rm = TRUE),
    sd_mean_ratio_control = within_study_control_sd / within_study_control_mean,
    sd_mean_ratio_treatment = within_study_treatment_sd / within_study_treatment_mean
  ) %>% 
  ggplot() + 
  geom_histogram(aes(x = sd_mean_ratio_control), fill = "blue", alpha = 0.4) + 
  geom_histogram(aes(x = sd_mean_ratio_treatment), fill = "red", alpha = 0.4) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  guides(size = "none") +
  theme(
    legend.position = "none",
    axis.text = element_text(color = "black"),
    axis.title = element_text(face = "bold", color = "black"),
    plot.caption = element_text(size = 10, color = "gray10", face = "italic")
  ) +
  labs(
    caption = "Red = Control, Blue = Treatment, Purple = Both\nThe value in each bar is the total number of effect sizes",
    x = "SD/Mean Ratio",
    y = "Frequency"
  )

print(sd_mean_ratio_bar_plot)

```

## Plot and imputed missing standard deviations
```{r}
# Indicate which individuals are used in more than one control or treatment to calculate sampling variances of non-independent observations differently. 
data_shared_indiv <- group_by(data, exp_id ) %>% 
  summarise(number_treatment= n())
data_sd <- left_join(data, data_shared_indiv, by = "exp_id")


# Calculate the within and between study impacts of pesticides on fish social behaviour
data_sd <- data_sd %>% 
  group_by(study_id) %>% 
  mutate(
    control_sd = as.numeric(control_sd),
    treatment_sd = as.numeric(treatment_sd)) %>%
  group_by(study_id) %>%
  mutate(
    within_study_control_mean = mean(control_mean, na.rm = TRUE),
    within_study_treatment_mean = mean(treatment_mean, na.rm = TRUE),
    within_study_control_sd = mean(control_sd, na.rm = TRUE),
    within_study_treatment_sd = mean(treatment_sd, na.rm = TRUE),
    sd_mean_ratio_control = within_study_control_sd / within_study_control_mean,
    sd_mean_ratio_treatment = within_study_treatment_sd / within_study_treatment_mean) %>% 
  ungroup() %>% 
  mutate(between_study_control_mean=mean(within_study_control_mean, na.rm=T),  
         between_study_treatment_mean=mean(within_study_treatment_mean, na.rm=T),
         between_study_control_sd=mean(within_study_control_sd, na.rm=T), 
         between_study_treatment_sd=mean(within_study_treatment_sd, na.rm=T)) 

data_sd %>% select(control_sd, treatment_sd) %>% impute_missingness() # Missing SD == 3.9%, 36 imputations needed 

dat_impSD <- as.data.frame(data_sd) # convert into dataframe
dat_impSD <- impute_SD(dat_impSD, 
                       columnSDnames = c("control_sd", "treatment_sd"), 
                       columnXnames = c("control_mean", "treatment_mean"), 
                       method = "Bracken1992")


# label missing location
dat_impSD$control_sd_report <- ifelse(is.na(data_sd$control_sd),"Yes","No")
dat_impSD$treatment_sd_report <- ifelse(is.na(data_sd$treatment_sd),"Yes","No")

# Convert sd columns to log10 and create a combined dataframe for plotting
dat_impSD_long <- dat_impSD %>%
  mutate(log_control_sd = log10(control_sd),
         log_treatment_sd = log10(treatment_sd)) %>%
  pivot_longer(cols = c(log_control_sd, log_treatment_sd), 
               names_to = "type", 
               values_to = "log_sd") %>%
  mutate(reported = ifelse(type == "log_control_sd", control_sd_report, treatment_sd_report))

# Create the plot
imputed_sd_plot <- ggplot(dat_impSD_long, aes(x = factor(study_id), y = log_sd, color = reported)) +
  geom_point(size = 2, alpha = 0.5) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 8, name = "Dark2")[c(1, 2)]) +
  theme_bw() +
  theme(
    legend.position = "none", 
    axis.text = element_text(color = "black"),
    axis.title = element_text(face = "bold", color = "black"),
    plot.caption = element_text(size = 10, color = "gray10", face = "italic"),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5) 
  ) +
  labs(
    caption = "Points with 'red' indicate missing standard deviations that were imputed",
    x = "Study ID",
    y = "Log10(SD Value)",
    color = "Reported"
  )

# Print the plot
print(imputed_sd_plot)
```

## **Calculate effect sizes and sampling variances**
```{r}
# Make sure all data is numeric 
data <- dat_impSD %>%
  mutate(
    treatment_mean = as.numeric(treatment_mean),
    treatment_sd = as.numeric(treatment_sd),
    treatment_n = as.numeric(treatment_n),
    control_mean = as.numeric(control_mean),
    control_sd = as.numeric(control_sd),
    control_n = as.numeric(control_n)
  )

# Calculate log response ratio (lnRR)
lnRR <- escalc(measure = "ROM", 
               m1i = treatment_mean, sd1i = treatment_sd, n1i = treatment_n, 
               m2i = control_mean, sd2i = control_sd, n2i = control_n, 
               data = data)

# Calculate log coeffidata# Calculate log coefficient variation ratio (lnCVR)
lnCVR <- escalc(measure = "CVR", 
               m1i = treatment_mean, sd1i = treatment_sd, n1i = treatment_n, 
               m2i = control_mean, sd2i = control_sd, n2i = control_n, 
               data = data)

# Calculate the standardised mean difference for sensitivity analysis
SMD <- escalc(measure = "SMD", 
               m1i = treatment_mean, sd1i = treatment_sd, n1i = treatment_n, 
               m2i = control_mean, sd2i = control_sd, n2i = control_n, 
               data = data)

# Calculate the standardised mean difference with heteroscedacity for sensitivity analysis
SMDH <- escalc(measure = "SMDH", 
               m1i = treatment_mean, sd1i = treatment_sd, n1i = treatment_n, 
               m2i = control_mean, sd2i = control_sd, n2i = control_n, 
               data = data)

# Calculate log variation ratio (lnVR)
lnVR <- escalc(measure = "VR", 
               m1i = treatment_mean, sd1i = treatment_sd, n1i = treatment_n, 
               m2i = control_mean, sd2i = control_sd, n2i = control_n, 
               data = data)

# Summary statistics of effect size estimates
effect_size_summaries <- list(
  lnRR = summary(lnRR$yi),
  lnCVR = summary(lnCVR$yi),
  SMD = summary(SMD$yi),
  SMDH = summary(SMDH$yi),
  VR = summary(lnVR$yi)
)

# Summary statistics of sampling variances
sampling_variance_summaries <- list(
  lnRR = summary(lnRR$vi),
  lnCVR = summary(lnCVR$vi),
  SMD = summary(SMD$vi),
  SMDH = summary(SMDH$vi),
  VR = summary(lnVR$vi)
)

# Calculate precision for each effect size estimate with checks
lnRR$precision <- ifelse(lnRR$vi > 0, 1 / sqrt(lnRR$vi), NA)
lnCVR$precision <- ifelse(lnCVR$vi > 0, 1 / sqrt(lnCVR$vi), NA)
SMD$precision <- ifelse(SMD$vi > 0, 1 / sqrt(SMD$vi), NA)
SMDH$precision <- ifelse(SMDH$vi > 0, 1 / sqrt(SMDH$vi), NA)
lnVR$precision <- ifelse(lnVR$vi > 0, 1 / sqrt(lnVR$vi), NA)

# Merge each of the effect size with precision
effect_size_metrics_set <- data.frame(
  lnRR = lnRR$yi, lnRRv = lnRR$vi, lnRR_precision = lnRR$precision,
  lnVR = lnVR$yi, lnVRv = lnVR$vi, lnVR_precision = lnVR$precision,
  lnCVR = lnCVR$yi, lnCVRv = lnCVR$vi, lnCVR_precision = lnCVR$precision,
  SMD = SMD$yi, SMDv = SMD$vi, SMD_precision = SMD$precision,
  SMDH = SMDH$yi, SMDHv = SMDH$vi, SMDH_precision = SMDH$precision, control_imputed = dat_impSD$control_sd_report, treatment_imputed = dat_impSD$treatment_sd_report)

 # Bind the effect size metrics set to the main data
data <- cbind(data, effect_size_metrics_set)

# Select specific columns including the new precision columns
effect_size_metrics_set_kable <- data[, which(colnames(data) %in% c(
  "study_id", "exp_id", "assay_id", "species_english", "pesticide",
  "lnRR", "lnRRv", "lnRR_precision", 
  "lnCVR", "lnCVRv", "lnCVR_precision", 
  "lnVR", "lnVRv", "lnVR_precision", 
  "SMD", "SMDv", "SMD_precision", 
  "SMDH", "SMDHv", "SMDH_precision",
  "control_imputed", "treatment_imputed"
))] %>% dfround(digits = 3)


# Table of the effect sizes
 kable(effect_size_metrics_set_kable, "html") %>%
    kable_styling("bordered", position = "left") %>%
    scroll_box(width = "250%", height = "800px")

```

